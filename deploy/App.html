<!DOCTYPE html>
<html>
<head>
    <title>rallymonthlyteamreport</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"filter-pulldown-container",layout:{type:"hbox"}},{xtype:"container",itemId:"grid-container",margin:"0 0 0 50"}],launch:function(){console.log("Calling _loadMonthPulldown"),this._loadMonthPulldown(),this._loadTeamsPulldown()},_loadMonthPulldown:function(){Ext.define("Month",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"startDate",type:"string"},{name:"endDate",type:"string"},{name:"dateString",type:"string"}]});var myStore=Ext.create("Ext.data.Store",{model:"Month",data:[{name:"Jan 1st, 2014",startDate:"2014-01-01",endDate:"2014-01-31"},{name:"Feb 1st, 2014",startDate:"2014-02-01",endDate:"2014-02-28"},{name:"Mar 1st, 2014",startDate:"2014-03-01",endDate:"2014-03-31"}]}),monthCombobox=Ext.create("Rally.ui.combobox.ComboBox",{itemId:"month-combobox",fieldLabel:"Month",labelAlign:"right",displayField:"name",valueField:"startDate",width:300,store:myStore,listeners:{select:this._onMonthSelected,scope:this}});this.down("#filter-pulldown-container").add(monthCombobox)},_onMonthSelected:function(combo,records){console.log("selected month",records[0].get("startDate"),records[0].get("endDate")),this.selectedStartDate=records[0].get("startDate"),this.selectedEndDate=records[0].get("endDate"),this._fetchIterations()},_loadTeamsPulldown:function(){var teamCombobox=Ext.create("Rally.ui.combobox.ComboBox",{itemId:"team-combobox",fieldLabel:"Team",labelAlign:"right",width:300,storeConfig:{autoLoad:!0,model:"Project",filters:[{property:"Name",operator:"!contains",value:"Deprecated"}]},listeners:{select:this._onTeamSelected,scope:this}});this.down("#filter-pulldown-container").add(teamCombobox)},_onTeamSelected:function(combo,records){console.log("%s team was selected",records[0]),console.log("%s team was selected",records[0].get("Name")),console.log(records[0]),this.selectedTeam=records[0].get("_ref"),this._fetchIterations()},_fetchIterations:function(){Ext.create("Rally.data.wsapi.Store",{model:"Iteration",filters:[{property:"StartDate",operator:">=",value:this.selectedStartDate},{property:"EndDate",operator:"<=",value:this.selectedEndDate},{property:"Project",operator:"=",value:this.selectedTeam}],autoLoad:!0,listeners:{load:this._onIterationsLoaded,scope:this}})},_onIterationsLoaded:function(store,records,successful){console.log("got iterations",records),this.Iterations=records,this._loadStories()},_loadStories:function(){console.log("Loading stories");var iterationFilters=null;if(0!==this.Iterations.length){var iterFilter1=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:this.Iterations[0].get("_ref")});if(iterationFilters=iterFilter1,this.Iterations.length>1){var iterFilter2=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:this.Iterations[1].get("_ref")});iterationFilters=iterFilter1.or(iterFilter2)}console.log("iteration filters",""+iterationFilters),Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,context:{project:this.selectedTeam},fetch:["Feature","Name","Notes","PercentDoneByStoryPlanEstimate","Parent"],filters:[iterationFilters],listeners:{load:this._onStoriesLoaded,scope:this}})}},_onStoriesLoaded:function(store,storyRecords,success){console.log("got %i stories",storyRecords.length),this._getUniqueFeatures(storyRecords)},_getUniqueFeatures:function(storyRecords){var featureList={};_.each(storyRecords,function(record){console.log("%s",record.get("Name"),record);var feature=record.get("Feature");if(null===feature)featureRef="NoFeature",featureList[featureRef]={Name:"No Feature Assigned"};else{var featureRef=feature._ref;featureList[featureRef]=feature}console.log(featureRef,feature,featureList)}),this._getUniquePrograms(featureList)},_getUniquePrograms:function(featureList){console.log("_getUniquePrograms is running");var featureKeys=_.keys(featureList);console.log("%s features found",featureKeys.length);var programList={};_.each(featureKeys,function(featureKey){var program=featureList[featureKey].Parent;console.log(featureList[featureKey]," from program ",program),null==program?(programRef="NoProgram",programList[programRef]={Name:"No Program Assigned"}):(programRef=program._ref,programList[programRef]=program)}),console.log("Program List: ",programList),this._loadView(featureList,programList)},_loadView:function(featureList,programList){featureRows=[],_.each(_.keys(featureList),function(featureKey){feature=featureList[featureKey];var programName;programName=void 0===feature.Parent?"No Program":feature.Parent.Name;var featureNotes=void 0===feature.Notes?"":feature.Notes;console.log("GOT!",feature,feature.Name),featureRows.push({program:programName,feature:feature.Name,overallProgress:feature.PercentDoneByStoryPlanEstimate,notes:featureNotes})}),Ext.define("ReportModel",{extend:"Ext.data.Model",fields:[{name:"program",type:"string"},{name:"feature",type:"string"},{name:"notes",type:"string"},{name:"overallProgress",type:"string"}]});var myStore=Ext.create("Ext.data.Store",{model:"ReportModel",data:featureRows});void 0!==this.grid&&this.grid.destroy(),this.grid=Ext.create("Rally.ui.grid.Grid",{title:"Montly Team Report",itemId:"featuresGrid",columnLines:!0,header:!1,showRowActionsColumn:!1,store:myStore,width:1e3,border:1,columnCfgs:[{text:"Program",dataIndex:"program",sortable:!0,flex:2},{text:"Feature",dataIndex:"feature",sortable:!0,flex:2},{text:"Overall Progress",dataIndex:"overallProgress",flex:1,renderer:this._renderOverallProgress,scope:this,sortable:!0,width:50},{text:"Notes",dataIndex:"notes",sortable:!1,flex:5}],viewConfig:{enableTextSelection:!0}}),this.down("#grid-container").add(this.grid)},_renderOverallProgress:function(value,metaData,record,rowIndex,colIndex,store,view){var percentValue=(100*value).toFixed(2);return Ext.String.format("{0}",percentValue)}});

            Rally.launchApp('CustomApp', {
                name:"rallymonthlyteamreport",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
